---
default:
  image: ruby:3.3
  before_script:
    - bundle config set path 'vendor'  # Install dependencies into ./vendor/ruby

variables:
  CACHE_FALLBACK_KEY: "$CI_COMMIT_REF_SLUG"

stages:
  - deploy

deploy_staging:
  cache:
    - key:
        files:
          - Gemfile.deploy.lock
      paths:
        - vendor/ruby
  stage: deploy
  script:
    - bundle install -j $(nproc) --gemfile=Gemfile.deploy
    - mkdir ~/.ssh
    - mv "$SSH_ID_RSA" ~/.ssh/id_rsa
    - mv "$SSH_CONFIG_FILE" ~/.ssh/config
    - bundle exec --gemfile=Gemfile.deploy cap staging deploy
  environment:
    name: staging
    url: https://plm-ppp.thape.com.cn
  rules:
    - if: '$CI_COMMIT_REF_NAME == "new_dev"'

deploy_production:
  cache:
    - key:
        files:
          - Gemfile.deploy.lock
      paths:
        - vendor/ruby
  stage: deploy
  script:
    - bundle install -j $(nproc) --gemfile=Gemfile.deploy
    - mkdir ~/.ssh
    - mv "$SSH_ID_RSA" ~/.ssh/id_rsa
    - mv "$SSH_CONFIG_FILE" ~/.ssh/config
    - bundle exec --gemfile=Gemfile.deploy cap production deploy
  environment:
    name: production
    url: https://plm.thape.com.cn
  when: manual
  rules:
    - if: '$CI_COMMIT_REF_NAME == "new_prod"'
